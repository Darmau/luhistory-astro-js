---
import Layout from "../../../layouts/Layout.astro";
import {sanityClient} from "sanity:client";
import {Image} from "astro:assets";
import PublicationCategory from "../../../data/PublicationCategory";
import PageTitle from "../../../components/PageTitle.astro";

export async function getStaticPaths() {
  const allBooks = await sanityClient.fetch(`*[_type == 'book' && defined(slug) && defined(publishDate) && defined(category)] | order(publishDate desc) {
    title,
    publishDate,
    category,
    "slug": slug.current,
    "cover": cover.asset->url
}`)
  const paths = allBooks.map((book) => {
    // 筛选出同一分类的书籍
    const filteredBooks = allBooks.filter((b) => b.category === book.category);
    return {
      params: {
        category: book.category,
      },
      props: {
        category: book.category,
        books: filteredBooks,
      }
    }
  });
  return paths;
}
const {books, category} = Astro.props;
const params = Astro.params;
---

<Layout>
  <PageTitle title="Publications" subtitle="Repellat molestiae nihil iusto quo quia. In voluptatum hic libero omnis ullam deleniti. Quia vel voluptatem voluptatem excepturi omnis id." bgWhite="flase" />

  <main class="max-w-8xl mx-auto grid grid-cols-12 gap-8 py-16 mb-24">
    <ul class="col-span-2 space-y-2">
      <li class="text-sm text-neutral-900 tracking-wider">
        <a
          class="text-sm text-neutral-900 opacity-50 tracking-wider hover:opacity-100"
          href={`/book/category`}
          data-astro-prefetch>
          ALL
        </a>
      </li>
      {PublicationCategory.map((category) => {
        return (
          <li>
            <a
              class={`${category === params.category ? 'text-neutral-900' : 'text-neutral-900 opacity-50'} text-sm tracking-wider hover:opacity-100`}
              href={`/book/category/${category}`}
              data-astro-prefetch>
              {category.split('-').join(' ').toUpperCase()}
            </a>
          </li>
        );
      })}
    </ul>
    <ul class="col-start-4 col-end-12 grid grid-cols-4 gap-8">
      {books.map((book) => (
        <li>
          <a href={`/book/detail/${book.slug}`} class="flex flex-col gap-4" data-astro-prefetch>
            <div class="h-45 w-45 aspect-square bg-neutral-100 flex items-center justify-center shrink-0">
              {book.cover && (
                <Image
                  src={book.cover}
                  alt={book.title}
                  class="h-3/4 w-3/4 object-contain"
                  height="128"
                  width="128"
                />
              )
              }
            </div>
            <div class="space-y-2">
              <h3 class="font-serif font-bold text-neutral-900 text-2xl">{book.title}</h3>
              <p class="text-neutral-900 opacity-50">{new Date(book.publishDate).getFullYear()}</p>
            </div>
          </a>
        </li>
      ))}
    </ul>
  </main>
</Layout>
